clear;
clc;

% symbols & channel
SNR_dB = 10;
No = 10^(-SNR_dB/10);
M = 16;                                                      % M-ary QAM
sym_bitnum = log2(M);                                       % Bit number in 1 M-ary modulation symbol
sympool = qammod(0:M-1, M, "UnitAveragePower", true);       % The symbol pool to store all possible M-ary modulation symbols               
tx_num = 8;                                                 % Tx antenna number
rx_num = 8;

% detection settings
iter_times = 10;
iter_diff_min = 1e-14;

%% simulation
% sim - Tx
% Create symbols
x = [-0.316227766016838 - 0.948683298050514j,0.948683298050514 + 0.948683298050514j,-0.948683298050514 - 0.948683298050514j,-0.948683298050514 - 0.948683298050514j,0.316227766016838 - 0.948683298050514j,0.316227766016838 + 0.948683298050514j,-0.316227766016838 + 0.316227766016838j,0.316227766016838 + 0.948683298050514j];
x = x.';

% sim - channel
% Rayleigh fadding channel
H = [-0.0937184605078695 - 0.325789208467691i,-0.409948660388057 + 0.127624248761650i,-0.340198805436454 - 0.183906567544389i,-0.178758506316793 + 0.282813964629862i,0.244065499436287 + 0.119275074002712i,0.404652046497070 + 0.130115778719934i,-0.291995417387099 - 0.229923768101160i,-0.334894332699780 + 0.0552525464226465i;0.219622958056395 + 0.0725650981717629i,-0.363320175835611 + 0.410690295022615i,0.00692933600943072 - 0.213998656152920i,-0.253960669290041 - 0.440478759146248i,-0.472729539619085 - 0.155380972373546i,-0.159472633495758 - 0.260200215366137i,0.579662075432111 - 0.176605488514093i,-0.321362725313180 - 0.0985553074645269i;-0.249502891226177 + 0.109915862833289i,-0.200843803086221 - 0.153781516981002i,-0.0869521190125238 + 0.453277723476347i,-0.0440070015458638 - 0.287959010065623i,-0.181405807253415 - 0.468786004067099i,-0.112888548447680 + 0.147966207646305i,-0.249464284100109 - 0.160513111663995i,-0.419130754674168 + 0.209460263241973i;0.0176151648445601 + 0.125848308893588i,0.210644374774806 - 0.157167834867619i,0.306031314204907 + 0.215087434405301i,0.00532363792563540 - 0.0920732534589593i,-0.0677664395372975 + 0.0769465492113715i,0.0444323433005837 - 0.0729021840594816i,-0.176246859761254 - 0.379934430344965i,0.188967004063272 + 0.0948510566517124i;-0.0726354203072265 - 0.152514963826217i,0.0124605347653776 - 0.0441394770780427i,-0.183412339395723 + 0.141956075550182i,-0.365225880781488 + 0.371034509203690i,-0.562893120541784 + 0.00976137490744553i,0.203617392271879 - 0.0590450542613002i,0.226791021880027 - 0.436348465887214i,-0.223942217083107 + 0.369899560834625i;-0.194585576650982 - 0.0884840892415303i,0.311989962765037 + 0.290313533258155i,0.394887920260293 + 0.00166045371238855i,0.0276114079947778 + 0.0977741442568030i,-0.648536770066346 - 0.190426271634298i,0.219959438133846 - 0.219194754563237i,0.0438843795195583 - 0.782226653833541i,-0.433660198611319 + 0.0595437346837353i;0.0221390631775426 - 0.108024922224070i,0.246773896846918 - 0.0996170232135530i,0.0635643772442668 - 0.149946713553520i,-0.192163956072254 + 0.326913229112732i,-0.423381488059090 - 0.137478693637404i,0.626489889494401 - 0.209204085478038i,0.0170610807015928 + 0.136421979177171i,0.119137549971632 + 0.134745709911560i;-0.368418607630750 + 0.0411196888132931i,-0.120279128094159 + 0.232088798800701i,0.116098052448713 + 0.293807787523707i,0.105337773334338 - 0.144294641487873i,0.223850108811265 - 0.194860166350551i,0.118196998274075 - 0.168236450019131i,0.00147906268446563 - 0.243681938057881i,-0.0634923967675354 - 0.0946825964887651i];
% Noise
noise = [-0.204527964982421 - 0.0500389056202131i;-0.385548490587204 - 0.0612078926273433i;-0.306621809863722 + 0.140884055425924i;0.393714151395090 - 0.0708234588599821i;-0.290296669529387 + 0.0540351317620554i;0.114491656811451 + 0.316821580231710i;0.0152629620793205 + 0.138432740431822i;0.154159965160627 - 0.132990175724025i];
% through Rayleigh fadding channel to get y 
y = H*x + noise;

% sim - Rx
% BPIC - ZF - uniform
bpic = BPIC(sympool, "bso_mean_init", BPIC.BSO_MEAN_INIT_ZF, "bso_mean_cal", BPIC.BSO_MEAN_CAL_ZF, "bso_var", BPIC.BSO_VAR_APPRO, "bso_var_cal", BPIC.BSO_VAR_CAL_ZF, "dsc_ise", BPIC.DSC_ISE_ZF, "iter_diff_min", iter_diff_min);
syms_BPIC_ZF_Uniform = bpic.detect(y, H, No);

