clear;
clc;

% symbols & channel
SNR_dB = 10;
No = 10^(-SNR_dB/10);
M = 16;                                                      % M-ary QAM
sym_bitnum = log2(M);                                       % Bit number in 1 M-ary modulation symbol
sympool = qammod(0:M-1, M, "UnitAveragePower", true);       % The symbol pool to store all possible M-ary modulation symbols               
tx_num = 6;                                                 % Tx antenna number
rx_num = 8;

% detection settings
iter_times = 10;

%% simulation
% sim - Tx
nbits_len = tx_num*sym_bitnum;
nbits = [0;0;0;0;1;0;1;1;0;1;1;1;1;0;1;0;0;1;1;0;0;1;1;1];
% Create symbols
x = qammod(nbits, M,'InputType','bit','UnitAveragePower',true);

% sim - channel
% Rayleigh fadding channel
H = [0.0779842980275662 - 0.622759649033581i,-0.142875802631333 - 0.408488171598999i,-0.174323667474292 + 0.109478245089320i,-0.368966477081844 - 0.276921619825361i,0.00153623951780131 - 0.154502633467246i,-0.122964279233259 - 0.0164804978420562i;-0.183137392048928 + 0.0271114323201603i,-0.180371427216861 - 0.00962913960198872i,-0.106442681285029 - 0.650355701183657i,-0.168757492195561 - 0.142235811473194i,0.328844132623829 - 0.0756248523168705i,-0.587173094540851 + 0.0842314391352496i;0.181796970844150 - 0.274582437390115i,-0.269517005491472 + 0.0753782055348761i,-0.241958959549706 - 0.337273794607423i,-0.178807013491370 + 0.127322067357151i,0.123368565654773 - 0.316219049081301i,-0.383520086717652 - 0.177425089797263i;-0.0228728145864274 + 0.338497555994102i,-0.0804609520079283 + 0.150975517592066i,-0.0815435205981982 + 0.346977587619771i,0.154528101457900 - 0.0591103469392555i,0.0522594800681023 + 0.158550051599941i,-0.0923430240796915 - 0.00393844929589852i;0.397490985713344 + 0.500879032759204i,-0.0578865696423046 + 0.195371532926671i,1.03053206097488 - 0.190738801731184i,0.139426352501500 - 0.282268546757656i,0.189798052064987 - 0.627758884668258i,0.238281250454043 + 0.118966918969035i;-0.406515930069576 - 0.107299405920014i,0.0394737737134317 + 0.194681257226061i,0.983669864502787 + 0.0945581499725686i,0.0313140593238832 - 0.454070567845001i,0.168657178927005 + 0.0417466539734718i,-0.0661911325773498 - 0.270531785576486i;0.0407700751879210 + 0.344350212901169i,-0.255000850654891 + 0.195836910913300i,0.331086667554220 + 0.435358787558427i,-0.0982317389826576 - 0.106885307261230i,-0.466629295288548 + 0.193133316984322i,0.0757052888255151 + 0.241089069892722i;0.372309919923952 + 0.275294472323379i,0.0238266459516009 - 0.0902339925878703i,0.227261674303623 - 0.256605913053121i,-0.267269417226659 - 0.0638391972248551i,0.00541968860813382 - 0.245035871941119i,-0.259224365936243 + 0.315966037522292i];
% Noise
noise = [0.0718181951981610 - 0.0880111639136088i;0.00337933343174761 - 0.486637718583503i;-0.260388448145171 - 0.267356458760811i;0.110649754927316 + 0.0816899119588328i;-0.271872098044113 + 0.539438666768092i;0.355711005382155 + 0.165524310537081i;0.117723399711715 + 0.0692613980711147i;0.0592152372889183 - 0.121192018437500i];
% through Rayleigh fadding channel to get y 
y = H*x + noise;

% sim - Rx
% sim - Rx - Alva - B-PIC-DSC MMSE
[syms_BPIC_MMSE_Alva] = Detect_B_PIC_DSC_MMSE(sympool, y, H, No, iter_times);
% sim - Rx - Alva - ZF
[syms_BPIC_ZF_Alva] = Detect_B_PIC_DSC(sympool, y, H, No, iter_times);
% BPIC - MMSE
bpic = BPIC(sympool, "bso_mean_init", BPIC.BSO_MEAN_INIT_MMSE, "bso_var", BPIC.BSO_VAR_APPRO, "bso_var_cal", BPIC.BSO_VAR_CAL_MMSE, "dsc_ise", BPIC.DSC_ISE_MMSE, "detect_sour", BPIC.DETECT_SOUR_BSE);
syms_BPIC_MMSE = bpic.detect(y, H, No);
% BPIC - ZF
bpic = BPIC(sympool, "bso_mean_init", BPIC.BSO_MEAN_INIT_ZF, "bso_var", BPIC.BSO_VAR_APPRO, "bso_var_cal", BPIC.BSO_VAR_CAL_ZF, "dsc_ise", BPIC.DSC_ISE_ZF, "detect_sour", BPIC.DETECT_SOUR_BSE);
syms_BPIC_ZF = bpic.detect(y, H, No);
% BPIC - Paper
bpic = BPIC(sympool, "bso_mean_init", BPIC.BSO_MEAN_INIT_MRC, "bso_var", BPIC.BSO_VAR_APPRO, "bso_var_cal", BPIC.BSO_VAR_CAL_MRC, "dsc_ise", BPIC.DSC_ISE_MRC, "detect_sour", BPIC.DETECT_SOUR_BSE);
syms_BPIC_paper = bpic.detect(y, H, No);

fprintf("Estimated Symbol Difference(MMSE) is %.16f\n", sum(abs(syms_BPIC_MMSE - syms_BPIC_MMSE_Alva)));
fprintf("Estimated Symbol Difference(ZF) is %.16f\n", sum(abs(syms_BPIC_ZF - syms_BPIC_ZF_Alva)));